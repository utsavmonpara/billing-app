<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Billing App</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <header class="top-bar">
            <div class="logo-section">
                <!-- 3D Isometric Billing Logo -->
                <svg class="logo" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="blueFace" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#5B9BFF;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#2E5AC2;stop-opacity:1" />
                        </linearGradient>
                        <linearGradient id="greenFace" x1="0%" y1="100%" x2="100%" y2="0%">
                            <stop offset="0%" style="stop-color:#52D87F;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#27B558;stop-opacity:1" />
                        </linearGradient>
                        <linearGradient id="orangeFace" x1="100%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" style="stop-color:#FFB754;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#FF9500;stop-opacity:1" />
                        </linearGradient>
                        <linearGradient id="cardGold" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#FFD700;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#FFC700;stop-opacity:1" />
                        </linearGradient>
                        <linearGradient id="shadow" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#00000015;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#00000030;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    
                    <!-- Base/Ground -->
                    <polygon points="50,160 100,135 150,160 100,185" fill="#f0f0f0" opacity="0.6"/>
                    
                    <!-- Laptop Base - Isometric View -->
                    <!-- Front face (blue) -->
                    <polygon points="50,120 100,95 100,155 50,180" fill="url(#blueFace)" stroke="#1e3a8a" stroke-width="1.5"/>
                    
                    <!-- Top face (darker) -->
                    <polygon points="50,120 100,95 150,120 100,145" fill="#4285F4" stroke="#1e3a8a" stroke-width="1.5"/>
                    
                    <!-- Right face (orange) -->
                    <polygon points="100,95 150,120 150,180 100,155" fill="url(#orangeFace)" stroke="#d97706" stroke-width="1.5"/>
                    
                    <!-- Screen/Document on laptop -->
                    <polygon points="58,105 92,90 145,115 110,128" fill="#ffffff" stroke="#333" stroke-width="1" opacity="0.9"/>
                    
                    <!-- Document lines -->
                    <line x1="65" y1="96" x2="85" y2="88" stroke="#999" stroke-width="1.5" opacity="0.5"/>
                    <line x1="65" y1="104" x2="140" y2="110" stroke="#999" stroke-width="1" opacity="0.4"/>
                    <line x1="65" y1="110" x2="135" y2="115" stroke="#999" stroke-width="1" opacity="0.4"/>
                    
                    <!-- Dollar Sign / Currency Symbol -->
                    <circle cx="125" cy="75" r="15" fill="url(#greenFace)" stroke="#16a34a" stroke-width="1.5"/>
                    <text x="125" y="82" text-anchor="middle" font-size="20" font-weight="bold" fill="white">$</text>
                    
                    <!-- Credit Card floating -->
                    <rect x="130" y="140" width="35" height="22" rx="2" fill="url(#cardGold)" stroke="#d97706" stroke-width="1.5"/>
                    <rect x="135" y="150" width="20" height="6" fill="#333" opacity="0.3"/>
                    
                    <!-- Small circles for decoration (data points) -->
                    <circle cx="75" cy="135" r="4" fill="#5B9BFF" opacity="0.7"/>
                    <circle cx="90" cy="148" r="3" fill="#52D87F" opacity="0.7"/>
                    <circle cx="70" cy="165" r="3.5" fill="#FFB754" opacity="0.7"/>
                    
                    <!-- Subtle glow -->
                    <ellipse cx="100" cy="150" rx="50" ry="30" fill="url(#shadow)" opacity="0.4"/>
                </svg>
                <h1>Smart Billing</h1>
            </div>
            <a href="{{ url_for('history') }}" class="btn secondary">
                <span class="icon">üìã</span> Invoice History
            </a>
        </header>

        <section class="card">
            <h2>‚úèÔ∏è Create New Invoice</h2>
            
            <!-- Customer Information Section -->
            <div class="customer-section">
                <h3>Customer Information</h3>
                <div class="customer-row">
                    <div class="form-group">
                        <label for="customerName">Customer Name</label>
                        <input id="customerName" type="text" placeholder="Enter customer name" class="customer-input">
                    </div>
                    <div class="form-group">
                        <label for="customerEmail">Email (Optional)</label>
                        <input id="customerEmail" type="email" placeholder="customer@email.com" class="customer-input">
                    </div>
                </div>
            </div>

            <!-- Invoice Items Section -->
            <div class="items-section">
                <h3>Invoice Items</h3>
                <div class="inputs-row">
                    <input id="productName" type="text" placeholder="Product name" class="form-input">
                    <input id="quantity" type="number" min="1" placeholder="Qty" class="form-input qty-input">
                    <input id="rate" type="number" min="0" step="0.01" placeholder="Rate (‚Çπ)" class="form-input rate-input">
                    <button id="addItemBtn" class="btn primary btn-add">+ Add Item</button>
                </div>

                <table class="items-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Product</th>
                            <th>Qty</th>
                            <th>Rate (‚Çπ)</th>
                            <th>Line Total (‚Çπ)</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="itemsBody">
                    </tbody>
                </table>

                <!-- Totals Section -->
                <div class="total-section">
                    <div class="total-row">
                        <span>Subtotal:</span>
                        <span id="subtotal" class="total-amount">0.00</span>
                    </div>
                    <div class="total-row tax-row">
                        <span>Tax (0%):</span>
                        <span id="taxAmount" class="total-amount">0.00</span>
                    </div>
                    <div class="total-row grand-total-row">
                        <span>Grand Total:</span>
                        <span id="grandTotal" class="total-amount grand-total">0.00</span>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="actions-row">
                <button id="clearBtn" class="btn secondary btn-action">üóëÔ∏è Clear All</button>
                <button id="saveInvoiceBtn" class="btn success btn-action">‚úì Save Invoice</button>
            </div>
        </section>
    </div>

    <script>
        const items = [];
        const itemsBody = document.getElementById("itemsBody");
        const grandTotalEl = document.getElementById("grandTotal");
        const subtotalEl = document.getElementById("subtotal");
        const taxEl = document.getElementById("taxAmount");

        function renderTable() {
            itemsBody.innerHTML = "";
            let subtotal = 0;
            items.forEach((item, index) => {
                const tr = document.createElement("tr");
                subtotal += item.line_total;
                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td class="product-col">${item.product_name}</td>
                    <td>${item.quantity}</td>
                    <td>‚Çπ${item.rate.toFixed(2)}</td>
                    <td class="line-total">‚Çπ${item.line_total.toFixed(2)}</td>
                    <td><button class="btn danger btn-sm" onclick="removeItem(${index})">Delete</button></td>
                `;
                itemsBody.appendChild(tr);
            });
            
            const tax = subtotal * 0.0;
            const grandTotal = subtotal + tax;
            
            subtotalEl.textContent = subtotal.toFixed(2);
            taxEl.textContent = tax.toFixed(2);
            grandTotalEl.textContent = grandTotal.toFixed(2);
        }

        function addItem() {
            const name = document.getElementById("productName").value.trim();
            const qty = parseInt(document.getElementById("quantity").value);
            const rate = parseFloat(document.getElementById("rate").value);

            if (!name || !qty || !rate || qty <= 0 || rate < 0) {
                alert("‚ùå Please fill in all fields correctly.");
                return;
            }

            const lineTotal = qty * rate;
            items.push({
                product_name: name,
                quantity: qty,
                rate: rate,
                line_total: lineTotal
            });

            document.getElementById("productName").value = "";
            document.getElementById("quantity").value = "";
            document.getElementById("rate").value = "";
            document.getElementById("productName").focus();
            renderTable();
        }

        function removeItem(index) {
            if (confirm("üóëÔ∏è Delete this item?")) {
                items.splice(index, 1);
                renderTable();
            }
        }

        async function saveInvoice() {
            const customerName = document.getElementById("customerName").value.trim();
            if (!customerName) {
                alert("‚ùå Please enter customer name.");
                document.getElementById("customerName").focus();
                return;
            }
            
            if (items.length === 0) {
                alert("‚ùå No items to save. Add items first.");
                return;
            }

            const total = parseFloat(grandTotalEl.textContent);
            try {
                const response = await fetch("/save_invoice", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({
                        customer_name: customerName,
                        customer_email: document.getElementById("customerEmail").value.trim(),
                        items: items,
                        total: total
                    })
                });
                const data = await response.json();
                if (data.success) {
                    alert("‚úì Invoice #" + data.invoice_id + " saved successfully!");
                    items.length = 0;
                    document.getElementById("customerName").value = "";
                    document.getElementById("customerEmail").value = "";
                    renderTable();
                } else {
                    alert("‚ùå Error saving invoice.");
                }
            } catch (error) {
                alert("‚ùå Error: " + error.message);
            }
        }

        function clearAll() {
            if (confirm("‚ö†Ô∏è Clear all items?")) {
                items.length = 0;
                renderTable();
            }
        }

        document.getElementById("addItemBtn").addEventListener("click", addItem);
        document.getElementById("saveInvoiceBtn").addEventListener("click", saveInvoice);
        document.getElementById("clearBtn").addEventListener("click", clearAll);
        document.getElementById("productName").addEventListener("keypress", (e) => {
            if (e.key === "Enter") addItem();
        });
        document.getElementById("quantity").addEventListener("keypress", (e) => {
            if (e.key === "Enter") addItem();
        });
        document.getElementById("rate").addEventListener("keypress", (e) => {
            if (e.key === "Enter") addItem();
        });
    </script>
</body>
</html>
