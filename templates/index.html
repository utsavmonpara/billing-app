<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Billing App</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <header class="top-bar">
            <div class="logo-section">
                <svg class="logo" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="logoGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#3498db;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#2980b9;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <!-- Invoice/Receipt shape -->
                    <rect x="25" y="15" width="50" height="70" rx="4" fill="url(#logoGradient)" stroke="#2980b9" stroke-width="1.5"/>
                    <!-- Lines representing text -->
                    <line x1="35" y1="30" x2="65" y2="30" stroke="white" stroke-width="2" stroke-linecap="round"/>
                    <line x1="35" y1="40" x2="65" y2="40" stroke="white" stroke-width="1.5" stroke-linecap="round"/>
                    <line x1="35" y1="48" x2="60" y2="48" stroke="white" stroke-width="1.5" stroke-linecap="round"/>
                    <line x1="35" y1="56" x2="60" y2="56" stroke="white" stroke-width="1.5" stroke-linecap="round"/>
                    <!-- Amount highlight -->
                    <circle cx="50" cy="70" r="8" fill="#f39c12" stroke="white" stroke-width="1.5"/>
                    <text x="50" y="73" text-anchor="middle" font-size="8" fill="white" font-weight="bold">‚Çπ</text>
                </svg>
                <h1>Smart Billing</h1>
            </div>
            <a href="{{ url_for('history') }}" class="btn secondary">
                <span class="icon">üìã</span> Invoice History
            </a>
        </header>

        <section class="card">
            <h2>‚úèÔ∏è Create New Invoice</h2>
            
            <!-- Customer Information Section -->
            <div class="customer-section">
                <h3>Customer Information</h3>
                <div class="customer-row">
                    <div class="form-group">
                        <label for="customerName">Customer Name</label>
                        <input id="customerName" type="text" placeholder="Enter customer name" class="customer-input">
                    </div>
                    <div class="form-group">
                        <label for="customerEmail">Email (Optional)</label>
                        <input id="customerEmail" type="email" placeholder="customer@email.com" class="customer-input">
                    </div>
                </div>
            </div>

            <!-- Invoice Items Section -->
            <div class="items-section">
                <h3>Invoice Items</h3>
                <div class="inputs-row">
                    <input id="productName" type="text" placeholder="Product name" class="form-input">
                    <input id="quantity" type="number" min="1" placeholder="Qty" class="form-input qty-input">
                    <input id="rate" type="number" min="0" step="0.01" placeholder="Rate (‚Çπ)" class="form-input rate-input">
                    <button id="addItemBtn" class="btn primary btn-add">+ Add Item</button>
                </div>

                <table class="items-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Product</th>
                            <th>Qty</th>
                            <th>Rate (‚Çπ)</th>
                            <th>Line Total (‚Çπ)</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="itemsBody">
                    </tbody>
                </table>

                <!-- Totals Section -->
                <div class="total-section">
                    <div class="total-row">
                        <span>Subtotal:</span>
                        <span id="subtotal" class="total-amount">0.00</span>
                    </div>
                    <div class="total-row tax-row">
                        <span>Tax (0%):</span>
                        <span id="taxAmount" class="total-amount">0.00</span>
                    </div>
                    <div class="total-row grand-total-row">
                        <span>Grand Total:</span>
                        <span id="grandTotal" class="total-amount grand-total">0.00</span>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="actions-row">
                <button id="clearBtn" class="btn secondary btn-action">üóëÔ∏è Clear All</button>
                <button id="saveInvoiceBtn" class="btn success btn-action">‚úì Save Invoice</button>
            </div>
        </section>
    </div>

    <script>
        const items = [];
        const itemsBody = document.getElementById("itemsBody");
        const grandTotalEl = document.getElementById("grandTotal");
        const subtotalEl = document.getElementById("subtotal");
        const taxEl = document.getElementById("taxAmount");

        function renderTable() {
            itemsBody.innerHTML = "";
            let subtotal = 0;
            items.forEach((item, index) => {
                const tr = document.createElement("tr");
                subtotal += item.line_total;
                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td class="product-col">${item.product_name}</td>
                    <td>${item.quantity}</td>
                    <td>‚Çπ${item.rate.toFixed(2)}</td>
                    <td class="line-total">‚Çπ${item.line_total.toFixed(2)}</td>
                    <td><button class="btn danger btn-sm" onclick="removeItem(${index})">Delete</button></td>
                `;
                itemsBody.appendChild(tr);
            });
            
            const tax = subtotal * 0.0; // Change tax rate if needed
            const grandTotal = subtotal + tax;
            
            subtotalEl.textContent = subtotal.toFixed(2);
            taxEl.textContent = tax.toFixed(2);
            grandTotalEl.textContent = grandTotal.toFixed(2);
        }

        function addItem() {
            const name = document.getElementById("productName").value.trim();
            const qty = parseInt(document.getElementById("quantity").value);
            const rate = parseFloat(document.getElementById("rate").value);

            if (!name || !qty || !rate || qty <= 0 || rate < 0) {
                alert("‚ùå Please fill in all fields correctly.");
                return;
            }

            const lineTotal = qty * rate;
            items.push({
                product_name: name,
                quantity: qty,
                rate: rate,
                line_total: lineTotal
            });

            document.getElementById("productName").value = "";
            document.getElementById("quantity").value = "";
            document.getElementById("rate").value = "";
            document.getElementById("productName").focus();
            renderTable();
        }

        function removeItem(index) {
            if (confirm("üóëÔ∏è Delete this item?")) {
                items.splice(index, 1);
                renderTable();
            }
        }

        async function saveInvoice() {
            const customerName = document.getElementById("customerName").value.trim();
            if (!customerName) {
                alert("‚ùå Please enter customer name.");
                document.getElementById("customerName").focus();
                return;
            }
            
            if (items.length === 0) {
                alert("‚ùå No items to save. Add items first.");
                return;
            }

            const total = parseFloat(grandTotalEl.textContent);
            try {
                const response = await fetch("/save_invoice", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({
                        customer_name: customerName,
                        customer_email: document.getElementById("customerEmail").value.trim(),
                        items: items,
                        total: total
                    })
                });
                const data = await response.json();
                if (data.success) {
                    alert("‚úì Invoice #" + data.invoice_id + " saved successfully!");
                    items.length = 0;
                    document.getElementById("customerName").value = "";
                    document.getElementById("customerEmail").value = "";
                    renderTable();
                } else {
                    alert("‚ùå Error saving invoice.");
                }
            } catch (error) {
                alert("‚ùå Error: " + error.message);
            }
        }

        function clearAll() {
            if (confirm("‚ö†Ô∏è Clear all items?")) {
                items.length = 0;
                renderTable();
            }
        }

        document.getElementById("addItemBtn").addEventListener("click", addItem);
        document.getElementById("saveInvoiceBtn").addEventListener("click", saveInvoice);
        document.getElementById("clearBtn").addEventListener("click", clearAll);
        document.getElementById("productName").addEventListener("keypress", (e) => {
            if (e.key === "Enter") addItem();
        });
        document.getElementById("quantity").addEventListener("keypress", (e) => {
            if (e.key === "Enter") addItem();
        });
        document.getElementById("rate").addEventListener("keypress", (e) => {
            if (e.key === "Enter") addItem();
        });
    </script>
</body>
</html>
